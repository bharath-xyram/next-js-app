name: Deploy image to EC2

on:
  push:
    branches: ["main"]

env:
  AWS_REGION: us-east-1
  ECR_REGISTRY: 835360238037.dkr.ecr.us-east-1.amazonaws.com
  ECR_REPOSITORY: next-js-app

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_SSH_USER }}    # ec2-user for Amazon Linux
          port: '22'
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          timeout: 10m            # <-- fixed: use duration string (e.g. 10m or 600s)
          script: |
            set -e

            AWS_REGION="${{ env.AWS_REGION }}"
            ECR_REGISTRY="${{ env.ECR_REGISTRY }}"
            ECR_REPOSITORY="${{ env.ECR_REPOSITORY }}"
            IMAGE_LATEST="${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:latest"
            IMAGE_SHA="${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}"

            echo "Using ECR registry: $ECR_REGISTRY"
            echo "Using repository: $ECR_REPOSITORY"
            echo "IMAGE_LATEST = $IMAGE_LATEST"
            echo "IMAGE_SHA    = $IMAGE_SHA"

            # Install docker if missing (Amazon Linux)
            if ! command -v docker >/dev/null 2>&1; then
              sudo yum update -y
              sudo amazon-linux-extras install docker -y || sudo yum install -y docker
              sudo service docker start
              sudo usermod -aG docker ec2-user
            fi

            # Install aws CLI if missing (so aws ecr get-login-password will work)
            if ! command -v aws >/dev/null 2>&1; then
              curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
              unzip -q awscliv2.zip
              sudo ./aws/install
            fi

            # Login to ECR using instance role (recommended). If your EC2 doesn't have an instance role,
            # you can export AWS creds here (not recommended) or attach the role to the instance.
            aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${ECR_REGISTRY}

            # Pull the new images (latest and sha tag)
            sudo docker pull ${IMAGE_LATEST} || true
            sudo docker pull ${IMAGE_SHA} || true

            # Stop and remove existing container (if exists)
            sudo docker rm -f nextjs-container || true

            # Run new container (adjust ports/envs as necessary)
            sudo docker run -d --name nextjs-container \
              --restart unless-stopped \
              -p 80:3000 \
              ${IMAGE_LATEST}

            echo "Deployed ${IMAGE_LATEST}"
