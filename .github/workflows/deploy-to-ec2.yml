name: Deploy image to EC2

on:
  push:
    branches: ["main"]

env:
  AWS_REGION: us-east-1
  ECR_REGISTRY: 835360238037.dkr.ecr.us-east-1.amazonaws.com
  ECR_REPOSITORY: next-js-app

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_SSH_USER }}    # ec2-user for Amazon Linux
          port: '22'
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          timeout: 10m
          script: |
            set -euo pipefail

            AWS_REGION="${{ env.AWS_REGION }}"
            ECR_REGISTRY="${{ env.ECR_REGISTRY }}"
            ECR_REPOSITORY="${{ env.ECR_REPOSITORY }}"
            IMAGE_LATEST="${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:latest"
            IMAGE_SHA="${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}"

            echo "Using ECR registry: $ECR_REGISTRY"
            echo "Using repository: $ECR_REPOSITORY"
            echo "IMAGE_LATEST = $IMAGE_LATEST"
            echo "IMAGE_SHA    = $IMAGE_SHA"

            # Install docker if missing (Amazon Linux)
            if ! command -v docker >/dev/null 2>&1; then
              echo "Docker not found — installing..."
              sudo yum update -y
              sudo amazon-linux-extras install docker -y || sudo yum install -y docker
              sudo service docker start
              sudo usermod -aG docker ec2-user || true
            fi

            # Install aws CLI if missing (so aws ecr get-login-password will work)
            if ! command -v aws >/dev/null 2>&1; then
              echo "AWS CLI not found — installing..."
              curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
              unzip -q awscliv2.zip
              sudo ./aws/install
            fi

            # Login to ECR using instance role (recommended). If your EC2 doesn't have an instance role,
            # the instance needs AWS creds available (not recommended to embed).
            echo "Logging in to ECR..."
            aws ecr get-login-password --region "${AWS_REGION}" | sudo docker login --username AWS --password-stdin "${ECR_REGISTRY}"

            # Pull the new images (latest and sha tag)
            echo "Pulling images..."
            sudo docker pull "${IMAGE_LATEST}" || true
            sudo docker pull "${IMAGE_SHA}" || true

            # Ensure port 80 is free:
            echo "Ensuring host port 80 is free..."

            # If any docker container is publishing port 80, remove it
            CID=$(sudo docker ps --filter "publish=80" --format '{{.ID}}' | head -n1 || true)
            if [ -n "$CID" ]; then
              echo "Removing docker container $CID that uses port 80"
              sudo docker rm -f "$CID" || true
            else
              echo "No docker container is using port 80"
            fi

            # If still occupied, stop common web services (nginx/httpd)
            if sudo ss -ltnp | grep -q ':80'; then
              echo "Port 80 still in use — attempting to stop nginx/httpd services"
              if systemctl list-units --type=service --state=active | grep -q nginx; then
                sudo systemctl stop nginx || true
              fi
              if systemctl list-units --type=service --state=active | grep -q httpd; then
                sudo systemctl stop httpd || true
              fi
            fi

            # Final check — if still occupied show PID and exit
            if sudo ss -ltnp | grep -q ':80'; then
              echo "ERROR: port 80 still in use after attempts to free it. Current listeners:"
              sudo ss -ltnp | grep ':80' || true
              exit 1
            fi

            # Stop and remove existing container by name (if exists) — idempotent
            echo "Removing any existing container named nextjs-container..."
            sudo docker rm -f nextjs-container || true

            # Run new container (adjust ports/envs as necessary)
            echo "Starting new container from ${IMAGE_LATEST}..."
            sudo docker run -d --name nextjs-container \
              --restart unless-stopped \
              -p 80:3000 \
              "${IMAGE_LATEST}"

            echo "Deployed ${IMAGE_LATEST}"
