name: Deploy to EC2 (after build)

on:
  workflow_run:
    workflows: ["Build and push to ECR"]   # <--- exact name of your build workflow
    types:
      - completed

env:
  AWS_REGION: us-east-1
  ECR_REGISTRY: 835360238037.dkr.ecr.us-east-1.amazonaws.com
  ECR_REPOSITORY: next-js-app

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout (for context)
        uses: actions/checkout@v4

      - name: Deploy to EC2 via SSH and verify image
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_SSH_USER }}
          port: '22'
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          timeout: 10m
          script: |
            set -euo pipefail

            AWS_REGION="${{ env.AWS_REGION }}"
            ECR_REGISTRY="${{ env.ECR_REGISTRY }}"
            ECR_REPOSITORY="${{ env.ECR_REPOSITORY }}"

            # BUILD_SHA is the commit that the build workflow produced
            BUILD_SHA="${{ github.event.workflow_run.head_sha }}"
            if [ -z "${BUILD_SHA}" ]; then
              echo "ERROR: BUILD_SHA is empty"
              exit 1
            fi

            IMAGE_TAG="${ECR_REGISTRY}/${ECR_REPOSITORY}:${BUILD_SHA}"
            echo "Deploying image: ${IMAGE_TAG}"

            # Ensure aws & docker present (install if missing)
            if ! command -v docker >/dev/null 2>&1; then
              echo "Installing docker..."
              sudo yum update -y
              sudo amazon-linux-extras install docker -y || sudo yum install -y docker
              sudo service docker start
            fi
            if ! command -v aws >/dev/null 2>&1; then
              echo "Installing aws-cli..."
              curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
              unzip -q awscliv2.zip
              sudo ./aws/install
            fi

            # Login to ECR (uses instance role if available; otherwise the runner must provide creds)
            echo "Logging in to ECR..."
            aws ecr get-login-password --region "${AWS_REGION}" | sudo docker login --username AWS --password-stdin "${ECR_REGISTRY}"

            # Pull the exact tag built by the build workflow
            echo "Pulling ${IMAGE_TAG} ..."
            sudo docker pull "${IMAGE_TAG}"

            # Replace any container using port 80 (safe attempts)
            CID=$(sudo docker ps --filter "publish=80" --format '{{.ID}}' | head -n1 || true)
            if [ -n "$CID" ]; then
              echo "Removing docker container $CID that uses port 80"
              sudo docker rm -f "$CID" || true
            fi

            # Remove existing named container
            sudo docker rm -f nextjs-container || true

            # Run the new container by tag
            sudo docker run -d --name nextjs-container --restart unless-stopped -p 80:3000 "${IMAGE_TAG}"

            # --- Verification: compare running container image id to ECR manifest digest for BUILD_SHA ---
            echo "Verifying deployed image matches ECR..."

            # Get running container image ID (manifest digest-ish value)
            RUN_IMG_ID=$(sudo docker inspect --format '{{.Image}}' nextjs-container)
            echo "Running image id: $RUN_IMG_ID"

            # Get repo digests for that image id
            RUN_REPO_DIGESTS=$(sudo docker image inspect --format '{{json .RepoDigests}}' "$RUN_IMG_ID" || true)
            echo "Running RepoDigests: $RUN_REPO_DIGESTS"

            # Query ECR for the digest of the tag we just pulled (BUILD_SHA)
            ECR_DIGEST=$(aws ecr describe-images --repository-name "${ECR_REPOSITORY}" --image-ids imageTag="${BUILD_SHA}" --query 'imageDetails[0].imageDigest' --output text || true)
            echo "ECR digest for ${BUILD_SHA}: ${ECR_DIGEST}"

            if [ -z "${ECR_DIGEST}" ] || [ "${ECR_DIGEST}" = "None" ]; then
              echo "ERROR: Could not find ECR digest for tag ${BUILD_SHA}. Aborting."
              exit 1
            fi

            # Check if the digest exists in the running image's repo digests
            if echo "${RUN_REPO_DIGESTS}" | grep -q "${ECR_DIGEST}"; then
              echo "SUCCESS: EC2 container is running the exact image pushed by build (${BUILD_SHA}) -> ${ECR_DIGEST}"
            else
              echo "ERROR: mismatch! Running image does not include ECR digest ${ECR_DIGEST}"
              echo "Running RepoDigests: ${RUN_REPO_DIGESTS}"
              exit 1
            fi